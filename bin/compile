#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -euo pipefail

build_dir=$1
cache_dir=$2
env_dir=$3
bp_dir=$(dirname $(dirname $0))

current_dir=$(pwd)
nginx_file=$(${bp_dir}/scripts/build_ngx_ruby.sh | tail -n 1)
cd $current_dir

mkdir -p $build_dir/bin
$nginx_file | tar -xzC "${build_dir}/bin"
nginx_version=$("${build_dir}/bin/nginx" -v |& cut -d '/' -f 2-)
cp -a $bp_dir/scripts/{boot,config} -t $build_dir/bin/
echo "-----> Installed nginx ${nginx_version} to /app/bin"

mkdir -p $build_dir/config
cp $bp_dir/scripts/config/templates/mime.types $build_dir/config

mkdir -p $build_dir/logs

echo "starting SEO"

seo_env_vars=(MINIMUM_CARS_FOR_SITEMAP HEROKU_APP_NAME API_URL HOST BASE_ENV FORCE_SITEMAP)
for env_var in ${seo_env_vars[*]}
do
  file_path=$env_dir/$env_var
  if [ -f "$file_path" ]; then
    export "$env_var=$(cat $file_path)"
  fi
done

"${bp_dir}/scripts/config/make-seo" $build_dir
